var spareTags=["TagName","Q14","Q15","Q16","Inlet_Drive_Hz","Extract_Drive_Hz","Gas_Valve_%","TDE_Amber_Light","TDE_Red_Light"];function startPage(){null===sessionStorage.getItem("logon")&&(window.location.href="logon.php")}function startApp(){startupMakeBoothUrls(),boothApi("login",startupLoginCallback)}async function logCheck(){let t={},e=document.getElementById("account").value,a=document.getElementById("password").value;t.account=e,t.password=a;let n=JSON.stringify(t);await fetch("logcheck.php",{method:"POST",headers:{"Content-Type":"application/json"},body:n}).then(function(t){return console.log("Response "+t),t.text()}).then(function(t){onLogCheck(t)})}function onLogCheck(t){let e=document.getElementById("message"),a=JSON.parse(t);if(console.log(a),"message"in a&&(e.innerHTML=a.message),"OK"===a.state){e.innerHTML="Logged onto app. Connecting to HMS and booth";customerStore(a.customer),sessionStorage.setItem("logon","OK"),console.log("olc "+sessionStorage),startApp()}}function customerStore(t){let e=JSON.stringify(t),a=t.Pollinterval;sessionStorage.setItem("Pollinterval",a),sessionStorage.setItem("customer",e),a>0&&setInterval(doInstantValues,a)}function logOff(){sessionStorage.clear(),window.location="loggedoff.php"}function startupMakeBoothUrls(){let t="https://m2web.talk2m.com/t2mapi/",e="e0f02ddb-a13e-41ed-b5e2-166458d1cdb5",a="STLelectrical",n="Steve Woollard",s="STLelec1",l=JSON.parse(sessionStorage.getItem("customer")),o=l.Boothname,i=l.Boothuser,r=l.Boothpw;sessionStorage.setItem("loginUrl",t+"login?t2maccount="+a+"&t2musername="+n+"&t2mpassword="+s+"&t2mdeveloperid="+e);let c=t+"get/"+o+"/rcgi.bin/ParamForm?AST_Param=";sessionStorage.setItem("apiGet",c);let g="&t2maccount="+a+"&t2mdeveloperid="+e+"&t2musername="+n+"&t2mpassword="+s+"&t2mdeviceusername="+i+"&t2mdevicepassword="+r;sessionStorage.setItem("apiCredentials",g),sessionStorage.setItem("ivUrl",c+"$dtIV$ftT"+g),sessionStorage.setItem("tagUrl",c+"$dtTL"+g)}function startupLoginCallback(t){console.log(t);let e=JSON.parse(t);e.success||(errorShow("log in ",e.message,"It seems your booth user or password are wrong"),logOff()),boothApi("tags",startupTagsCallback)}function errorShow(t,e,a){alert("Error in "+t+"\nMessage is "+e+"\n"+a)}function startupTagsCallback(t){if("0"!==t[0]){tagsMakeList(t),window.location="index.php";return}alert(t[1]),window.location="index.php"}async function boothApi(t,e){switch(t){case"iv":url=sessionStorage.getItem("ivUrl");break;case"login":url=sessionStorage.getItem("loginUrl");break;case"tags":url=sessionStorage.getItem("tagUrl");break;case"history":url=sessionStorage.getItem("hisUrl")}let a=await fetch(url,{method:"GET",headers:{"Content-Type":"multipart/form-data"}}),n=await a.text();e(n)}function utilSplitCsvLine(t){return t.replace(/"/g,"").split(";")}function htmlClear(){return"<div style = 'clear: both'> </div>"}function tagsMakeList(t){let e=t.split("\n"),a=[];e.forEach(function t(e,n){let s=utilSplitCsvLine(e),l=[s[0],s[1],s[56]];a.push(l)}),console.log(a);let n=JSON.stringify(a);sessionStorage.setItem("tags",n)}function doTagHeadings(){tagRows=tagsGetFromStore(),console.log(tagRows),tagRows[0],tagsListHtml(tagRows)}function tagsListHtml(t){let e=" <h2>Tag headings</h2>";t.forEach(function t(a,n){e+=a+"<br>"});document.getElementById("content").innerHTML=e}function tagsGetFromStore(){let t=sessionStorage.getItem("tags"),e=JSON.parse(t),a=Object.entries(e);return a}function tagUnit(t){let e=sessionStorage.getItem("tags"),a=JSON.parse(e),n=Object.entries(a),s=n[t],l=s[1][2];return l}function doInstantValues(){let t=sessionStorage.getItem("Pollinterval");t>0?setInterval(pollInstantValues,1e3*t):pollInstantValues()}function pollInstantValues(){boothApi("iv",instantValues)}function instantValues(t){console.log("IV "+t);let e=new Date().toTimeString(),a=t.split("\n"),n="<h2>Current Values</h2>";n+="Time "+e+"<br><br>",n+="<b><span class='ivName'>Name</span>",n+="<span class='ivValue'>Value</span>",n+="<span class='ivUnit'>Units</span>",n+="<span class='ivAl'>Alarm</span></b>",n+=htmlClear(),a.forEach(function t(e,a){let s=e.replace(/"/g,"").split(";"),l=s[1];!spareTags.includes(l)&&s.length>2&&(n+=ivRowHtml(s),n+=htmlClear())});document.getElementById("content").innerHTML=n}function ivRowHtml(t){let e="";t[3]>0&&(e=" style='color:red; font-weight:bold;'");let a=t[0],n="<span class='ivName'"+e+">"+t[1]+"</span>";return n+="<span class='ivValue'"+e+">"+t[2]+"</span>",n+="<span class='ivUnit'"+e+">"+tagUnit(a)+"</span>",t[3]>0?n+="<span class='ivAlOn'>On</span>":n+="<span class='ivAl'>Off</span>",n}function hisPost(){let t=(reply=hisStart())[0],e=reply[1],a=hisEnd();document.getElementById("hisnext").style.visibility="hidden";let n=document.getElementById("hisfname");n.value=e+"history.txt";document.getElementById("hisfile").style.visibility="visible";let s="$dtHT$ftT$st"+t+"$et"+a;sessionStorage.setItem("hisFile",n),sessionStorage.setItem("boothHisParams",s),console.log(s)}function hisStart(){let t=document.getElementById("stday"),e=t.value,a=e.padStart(2,"0"),n=(e=(t=document.getElementById("stmon")).value).padStart(2,"0"),s=(e=(t=document.getElementById("styear")).value).padStart(2,"0"),l=(e=(t=document.getElementById("sthh")).value).padStart(2,"0"),o=(e=(t=document.getElementById("stmins")).value).padStart(2,"0");return[a+n+s+"_"+l+o+"00",s+n+a]}function hisEnd(){let t=document.getElementById("ndday"),e=t.value,a=e.padStart(2,"0"),n=(e=(t=document.getElementById("ndmon")).value).padStart(2,"0"),s=(e=(t=document.getElementById("ndyear")).value).padStart(2,"0"),l=(e=(t=document.getElementById("ndhh")).value).padStart(2,"0"),o=(e=(t=document.getElementById("ndmins")).value).padStart(2,"0");return a+n+s+"_"+l+o+"00"}function hisGo(){let t=document.getElementById("hisfname").value,e=sessionStorage.getItem("apiGet"),a=sessionStorage.getItem("apiCredentials"),n=sessionStorage.getItem("boothHisParams"),s=e+(n+="$fn"+t)+a;sessionStorage.setItem("hisUrl",s),sessionStorage.setItem("hisFile",t),console.log(s);let l;document.getElementById("status").innerHTML="Fetching data",boothApi("history",historyCallback)}function historyCallback(t){let e=sessionStorage.getItem("hisFile");historySave(t,e);let a;document.getElementById("status").innerHTML="Saving data"}function historySave(t,e){saveAs(new Blob([t],{type:"text/plain;charset=utf-8"}),e)}function settings(){let t=sessionStorage.getItem("customer"),e=JSON.parse(t),a=e.id;window.location="settings.php?id="+a}function settingsChange(t){let e=t.target,a=JSON.parse(sessionStorage.getItem("customer"));a.BoothName=e.BoothName.value,a.BoothPw=e.BoothPw.value,a.BoothUser=e.BoothUser.value,a.Password=e.Password.value,a.Pollinterval=e.Pollinterval.value,a.User=e.User.value,e.Pollinterval.value,sessionStorage.removeItem("customer"),customerStore(a)}async function testBoothSet(t,e){let a=await fetch(t),n=await a.text();e(n)}function fldChange(){}function test(t,e){switch(e&&console.log(sessionStorage),t){case 1:console.log(sessionStorage);break;case 2:boothApi("iv",instantValues);break;case 3:doInstantValues(1);break;case 4:startApp();break;case 5:startupMakeBoothUrls()}}